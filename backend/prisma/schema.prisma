generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String    @id @default(uuid())
  email              String    @unique
  password           String
  fullName           String
  role               Role      @default(MERCHANT)
  emailVerified      Boolean   @default(false)
  isActive           Boolean   @default(true)
  metaAccessToken    String?
  metaTokenExpiresAt DateTime?
  metaAdAccounts     String[]
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  stores             Store[]
  activityLogs       BrandActivityLog[]
  createdTickets     SupportTicket[]
}

model Store {
  id           String         @id @default(uuid())
  userId       String
  user         User           @relation(fields: [userId], references: [id])
  name         String
  subdomain    String         @unique
  customDomain String?        @unique
  description  String?
  logo         String?
  isActive     Boolean        @default(true)
  onboardingStatus         OnboardingStatus @default(NOT_STARTED)
  onboardingStartedAt      DateTime?
  onboardingCompletedAt    DateTime?
  lastOnboardingActivityAt DateTime?
  suspendedAt              DateTime?
  suspendedReason          String?
  layoutId     String?
  themeId              String?
  themeTemplate        Theme?                @relation(fields: [themeId], references: [id])
  theme                String                @default("toys")
  planId               String?
  plan                 Plan?                 @relation(fields: [planId], references: [id])
  provisioningStatus   ProvisioningStatus    @default(PENDING)
  category             String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  products     Product[]
  orders       Order[]
  settings     StoreSettings?
  categoryConfig StoreCategoryConfig?
  websiteCustomization WebsiteCustomization?
  activityLogs       BrandActivityLog[]
  onboardingSteps    BrandOnboardingStep[]
  onboarding         BrandOnboarding?
  tickets            SupportTicket[]
  communicationLogs  CommunicationLog[]
  callLogs           SupportCallLog[]
  provisioning       MerchantProvisioning?
  deployment         DeploymentMetadata?

  @@index([userId])
}

model StoreCategoryConfig {
  id        String   @id @default(uuid())
  storeId   String   @unique
  store     Store    @relation(fields: [storeId], references: [id])
  category  String
  config    Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model BrandOnboarding {
  id                 String           @id @default(uuid())
  storeId            String           @unique
  store              Store            @relation(fields: [storeId], references: [id])
  status             OnboardingStatus @default(NOT_STARTED)
  currentStep        Int              @default(1)
  completionPercent  Int              @default(0)
  stepData           Json?
  startedAt          DateTime?
  completedAt        DateTime?
  lastStepSavedAt    DateTime?
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
}

model Admin {
  id           String    @id @default(uuid())
  email        String    @unique
  password     String
  fullName     String
  role         AdminRole @default(SUPPORT_ADMIN)
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  ticketAssignments       TicketAssignment[] @relation("AssignedAdmin")
  ticketAssignmentsCreated TicketAssignment[] @relation("AssignedByAdmin")
  assignedTickets          SupportTicket[]    @relation("CurrentTicketAssignee")
  activityLogs             BrandActivityLog[]
  communicationLogs        CommunicationLog[]
  callLogs                 SupportCallLog[]
}

model BrandOnboardingStep {
  id          String               @id @default(uuid())
  storeId     String
  store       Store                @relation(fields: [storeId], references: [id])
  stepKey     String
  status      OnboardingStepStatus @default(PENDING)
  completedAt DateTime?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  @@unique([storeId, stepKey])
}

model BrandActivityLog {
  id        String            @id @default(uuid())
  storeId   String
  store     Store             @relation(fields: [storeId], references: [id])
  adminId   String?
  admin     Admin?            @relation(fields: [adminId], references: [id])
  userId    String?
  user      User?             @relation(fields: [userId], references: [id])
  actorType ActivityActorType
  action    String
  metadata  Json?
  createdAt DateTime          @default(now())
}

model PlatformAnalyticsAggregate {
  id              String              @id @default(uuid())
  periodType      AnalyticsPeriodType
  periodStart     DateTime
  periodEnd       DateTime
  totalStores     Int
  activeStores    Int
  totalMerchants  Int
  totalOrders     Int
  totalRevenue    Decimal             @db.Decimal(12, 2)
  averageOrderValue Decimal           @db.Decimal(12, 2)
  createdAt       DateTime            @default(now())

  @@index([periodType, periodStart, periodEnd])
}

model SupportTicket {
  id               String         @id @default(uuid())
  storeId          String
  store            Store          @relation(fields: [storeId], references: [id])
  createdByUserId  String?
  createdBy        User?          @relation(fields: [createdByUserId], references: [id])
  assignedAdminId  String?
  assignedAdmin    Admin?         @relation("CurrentTicketAssignee", fields: [assignedAdminId], references: [id])
  subject          String
  summary          String?
  status           TicketStatus   @default(OPEN)
  priority         TicketPriority @default(MEDIUM)
  source           TicketSource   @default(PORTAL)
  latestMessageAt  DateTime?
  lastResponseAt   DateTime?
  resolvedAt       DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  assignments      TicketAssignment[]
  communications   CommunicationLog[]
  callLogs         SupportCallLog[]
}

model TicketAssignment {
  id                String   @id @default(uuid())
  ticketId          String
  ticket            SupportTicket @relation(fields: [ticketId], references: [id])
  adminId           String
  admin             Admin    @relation("AssignedAdmin", fields: [adminId], references: [id])
  assignedByAdminId String?
  assignedByAdmin   Admin?   @relation("AssignedByAdmin", fields: [assignedByAdminId], references: [id])
  assignedAt        DateTime @default(now())
  unassignedAt      DateTime?
  isActive          Boolean  @default(true)
}

model SupportCallLog {
  id          String         @id @default(uuid())
  storeId     String
  store       Store          @relation(fields: [storeId], references: [id])
  adminId     String
  admin       Admin          @relation(fields: [adminId], references: [id])
  ticketId    String?
  ticket      SupportTicket? @relation(fields: [ticketId], references: [id])
  channel     SupportChannel
  notes       String
  occurredAt  DateTime       @default(now())
  createdAt   DateTime       @default(now())
}

model CommunicationLog {
  id         String                 @id @default(uuid())
  storeId    String
  store      Store                  @relation(fields: [storeId], references: [id])
  adminId    String
  admin      Admin                  @relation(fields: [adminId], references: [id])
  ticketId   String?
  ticket     SupportTicket?         @relation(fields: [ticketId], references: [id])
  channel    CommunicationChannel
  direction  CommunicationDirection @default(OUTBOUND)
  summary    String
  metadata   Json?
  occurredAt DateTime               @default(now())
  createdAt  DateTime               @default(now())
}

model Product {
  id             String           @id @default(uuid())
  storeId        String
  store          Store            @relation(fields: [storeId], references: [id])
  name           String
  description    String?
  price          Decimal          @db.Decimal(10, 2)
  compareAtPrice Decimal?         @db.Decimal(10, 2)
  sku            String?
  stock          Int              @default(0)
  images         String[]
  category       String?
  tags           String[]
  isFeatured     Boolean          @default(false)
  customFields   Json?            // Category-specific fields (size, color, brand, etc.)
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  variants       ProductVariant[]
  orderItems     OrderItem[]

  @@index([storeId])
  @@index([storeId, isActive])
  @@index([storeId, category])
  @@index([storeId, createdAt])
  @@index([name])
}

model ProductVariant {
  id        String   @id @default(uuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  name      String
  sku       String?
  price     Decimal? @db.Decimal(10, 2)
  stock     Int      @default(0)
  options   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
}

model Order {
  id                String            @id @default(uuid())
  storeId           String
  store             Store             @relation(fields: [storeId], references: [id])
  orderNumber       String            @unique
  customerEmail     String
  customerName      String
  shippingAddress   Json
  billingAddress    Json
  subtotal          Decimal           @db.Decimal(10, 2)
  tax               Decimal           @db.Decimal(10, 2)
  shipping          Decimal           @db.Decimal(10, 2)
  total             Decimal           @db.Decimal(10, 2)
  status            OrderStatus       @default(PENDING)
  paymentStatus     PaymentStatus     @default(PENDING)
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  items             OrderItem[]

  @@index([storeId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id          String   @id @default(uuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id])
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  name        String
  quantity    Int
  price       Decimal  @db.Decimal(10, 2)
  variantInfo Json?
  createdAt   DateTime @default(now())

  @@index([orderId])
  @@index([productId])
}

model StoreSettings {
  id             String   @id @default(uuid())
  storeId        String   @unique
  store          Store    @relation(fields: [storeId], references: [id])
  currency       String   @default("USD")
  timezone       String   @default("UTC")
  seoTitle       String?
  seoDescription String?
  socialImage    String?
  contactEmail   String?
  contactPhone   String?
  shippingMethods Json?
  paymentMethods  Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

enum Role {
  ADMIN
  MODERATOR
  MERCHANT
  CUSTOMER
}

enum AdminRole {
  SUPER_ADMIN
  SUPPORT_ADMIN
}

enum OnboardingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  BLOCKED
}

enum OnboardingStepStatus {
  PENDING
  COMPLETED
  SKIPPED
}

enum ActivityActorType {
  ADMIN
  MERCHANT
  SYSTEM
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketSource {
  CHATBOT
  EMAIL
  PORTAL
  ADMIN
}

enum AnalyticsPeriodType {
  DAILY
  WEEKLY
  MONTHLY
}

enum SupportChannel {
  PHONE
  VIDEO
  EMAIL
  CHAT
  OTHER
}

enum CommunicationChannel {
  EMAIL
  CHAT
  PHONE
  VIDEO
  OTHER
}

enum CommunicationDirection {
  INBOUND
  OUTBOUND
}

enum OrderStatus {
  PENDING
  CONFIRMED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum FulfillmentStatus {
  UNFULFILLED
  FULFILLED
  SHIPPED
  DELIVERED
}

enum ProvisioningStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  ROLLBACK
}

enum ThemeCategory {
  CLOTHING
  ELECTRONICS
  TOYSTORE
  FOOTWEAR
  FOOD_BEVERAGE
  COSMETICS
  PERFUME
  JEWELLERY
}

model Theme {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  category    ThemeCategory?
  description String?
  thumbnail   String?
  version     String   @default("1.0.0")
  isActive    Boolean  @default(true)
  config      Json?
  previewUrl  String?
  repository  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  stores      Store[]
}

model Plan {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique
  description     String?
  price           Decimal  @db.Decimal(10, 2)
  billingCycle    String   @default("monthly")
  features        Json
  productLimit    Int?
  orderLimit      Int?
  storageLimit    Int?
  bandwidthLimit  Int?
  isActive        Boolean  @default(true)
  isPopular       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  stores          Store[]
}

model MerchantProvisioning {
  id                    String              @id @default(uuid())
  storeId               String              @unique
  store                 Store               @relation(fields: [storeId], references: [id])
  status                ProvisioningStatus  @default(PENDING)
  workspaceCreated      Boolean             @default(false)
  dashboardCreated      Boolean             @default(false)
  websiteDeployed       Boolean             @default(false)
  dataInitialized       Boolean             @default(false)
  credentialsSent       Boolean             @default(false)
  currentStep           String?
  completionPercent     Int                 @default(0)
  errorLog              Json?
  retryCount            Int                 @default(0)
  startedAt             DateTime?
  completedAt           DateTime?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
}

model DeploymentMetadata {
  id                String   @id @default(uuid())
  storeId           String   @unique
  store             Store    @relation(fields: [storeId], references: [id])
  merchantId        String   @unique
  tenantNamespace   String   @unique
  dashboardUrl      String?
  websiteUrl        String?
  databaseName      String?
  deploymentConfig  Json?
  sslEnabled        Boolean  @default(false)
  dnsConfigured     Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model WebsiteCustomization {
  id              String   @id @default(uuid())
  storeId         String   @unique
  store           Store    @relation(fields: [storeId], references: [id])
  logo            String?
  favicon         String?
  brandColors     Json?
  typography      Json?
  heroSection     Json?
  aboutSection    Json?
  contactInfo     Json?
  headerStyle     String?
  footerContent   Json?
  metaTitle       String?
  metaDescription String?
  keywords        String[]
  socialLinks     Json?
  features        Json?
  ctaButtons      Json?
  navLinks        Json?
  announcementBar Json?
  newsletter      Json?
  productSections Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model MerchantCredentials {
  id                String   @id @default(uuid())
  userId            String   @unique
  storeId           String   @unique
  email             String
  temporaryPassword String   // Stored for admin view only
  mustChangePassword Boolean @default(true)
  lastPasswordChange DateTime?
  createdByAdminId  String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([email])
  @@index([storeId])
}
