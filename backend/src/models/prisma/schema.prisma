// Mirror of ../prisma/schema.prisma for editor visibility.
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  fullName      String
  role          Role     @default(MERCHANT)
  emailVerified Boolean  @default(false)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  stores        Store[]
}

model Store {
  id           String         @id @default(uuid())
  userId       String
  user         User           @relation(fields: [userId], references: [id])
  name         String
  subdomain    String         @unique
  customDomain String?        @unique
  description  String?
  logo         String?
  isActive     Boolean        @default(true)
  onboardingStatus         OnboardingStatus @default(NOT_STARTED)
  onboardingStartedAt      DateTime?
  onboardingCompletedAt    DateTime?
  lastOnboardingActivityAt DateTime?
  suspendedAt              DateTime?
  suspendedReason          String?
  layoutId     String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  products     Product[]
  orders       Order[]
  settings     StoreSettings?
  activityLogs       BrandActivityLog[]
  onboardingSteps    BrandOnboardingStep[]
  tickets            SupportTicket[]
  communicationLogs  CommunicationLog[]
  callLogs           SupportCallLog[]
}

model Admin {
  id           String    @id @default(uuid())
  email        String    @unique
  password     String
  fullName     String
  role         AdminRole @default(SUPPORT_ADMIN)
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  ticketAssignments       TicketAssignment[] @relation("AssignedAdmin")
  ticketAssignmentsCreated TicketAssignment[] @relation("AssignedByAdmin")
  assignedTickets          SupportTicket[]    @relation("CurrentTicketAssignee")
  activityLogs             BrandActivityLog[]
  communicationLogs        CommunicationLog[]
  callLogs                 SupportCallLog[]
}

model BrandOnboardingStep {
  id          String               @id @default(uuid())
  storeId     String
  store       Store                @relation(fields: [storeId], references: [id])
  stepKey     String
  status      OnboardingStepStatus @default(PENDING)
  completedAt DateTime?
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  @@unique([storeId, stepKey])
}

model BrandActivityLog {
  id        String            @id @default(uuid())
  storeId   String
  store     Store             @relation(fields: [storeId], references: [id])
  adminId   String?
  admin     Admin?            @relation(fields: [adminId], references: [id])
  userId    String?
  user      User?             @relation(fields: [userId], references: [id])
  actorType ActivityActorType
  action    String
  metadata  Json?
  createdAt DateTime          @default(now())
}

model PlatformAnalyticsAggregate {
  id                String              @id @default(uuid())
  periodType        AnalyticsPeriodType
  periodStart       DateTime
  periodEnd         DateTime
  totalStores       Int
  activeStores      Int
  totalMerchants    Int
  totalOrders       Int
  totalRevenue      Decimal             @db.Decimal(12, 2)
  averageOrderValue Decimal             @db.Decimal(12, 2)
  createdAt         DateTime            @default(now())

  @@index([periodType, periodStart, periodEnd])
}

model SupportTicket {
  id               String         @id @default(uuid())
  storeId          String
  store            Store          @relation(fields: [storeId], references: [id])
  createdByUserId  String?
  createdBy        User?          @relation(fields: [createdByUserId], references: [id])
  assignedAdminId  String?
  assignedAdmin    Admin?         @relation("CurrentTicketAssignee", fields: [assignedAdminId], references: [id])
  subject          String
  summary          String?
  status           TicketStatus   @default(OPEN)
  priority         TicketPriority @default(MEDIUM)
  source           TicketSource   @default(PORTAL)
  latestMessageAt  DateTime?
  lastResponseAt   DateTime?
  resolvedAt       DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  assignments      TicketAssignment[]
  communications   CommunicationLog[]
  callLogs         SupportCallLog[]
}

model TicketAssignment {
  id                String   @id @default(uuid())
  ticketId          String
  ticket            SupportTicket @relation(fields: [ticketId], references: [id])
  adminId           String
  admin             Admin    @relation("AssignedAdmin", fields: [adminId], references: [id])
  assignedByAdminId String?
  assignedByAdmin   Admin?   @relation("AssignedByAdmin", fields: [assignedByAdminId], references: [id])
  assignedAt        DateTime @default(now())
  unassignedAt      DateTime?
  isActive          Boolean  @default(true)
}

model SupportCallLog {
  id          String         @id @default(uuid())
  storeId     String
  store       Store          @relation(fields: [storeId], references: [id])
  adminId     String
  admin       Admin          @relation(fields: [adminId], references: [id])
  ticketId    String?
  ticket      SupportTicket? @relation(fields: [ticketId], references: [id])
  channel     SupportChannel
  notes       String
  occurredAt  DateTime       @default(now())
  createdAt   DateTime       @default(now())
}

model CommunicationLog {
  id         String                 @id @default(uuid())
  storeId    String
  store      Store                  @relation(fields: [storeId], references: [id])
  adminId    String
  admin      Admin                  @relation(fields: [adminId], references: [id])
  ticketId   String?
  ticket     SupportTicket?         @relation(fields: [ticketId], references: [id])
  channel    CommunicationChannel
  direction  CommunicationDirection @default(OUTBOUND)
  summary    String
  metadata   Json?
  occurredAt DateTime               @default(now())
  createdAt  DateTime               @default(now())
}

model Product {
  id             String           @id @default(uuid())
  storeId        String
  store          Store            @relation(fields: [storeId], references: [id])
  name           String
  description    String?
  price          Decimal          @db.Decimal(10, 2)
  compareAtPrice Decimal?         @db.Decimal(10, 2)
  sku            String?
  stock          Int              @default(0)
  images         String[]
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  variants       ProductVariant[]
  orderItems     OrderItem[]
}

model ProductVariant {
  id        String   @id @default(uuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  name      String
  sku       String?
  price     Decimal? @db.Decimal(10, 2)
  stock     Int      @default(0)
  options   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Order {
  id                String            @id @default(uuid())
  storeId           String
  store             Store             @relation(fields: [storeId], references: [id])
  orderNumber       String            @unique
  customerEmail     String
  customerName      String
  shippingAddress   Json
  billingAddress    Json
  subtotal          Decimal           @db.Decimal(10, 2)
  tax               Decimal           @db.Decimal(10, 2)
  shipping          Decimal           @db.Decimal(10, 2)
  total             Decimal           @db.Decimal(10, 2)
  status            OrderStatus       @default(PENDING)
  paymentStatus     PaymentStatus     @default(PENDING)
  fulfillmentStatus FulfillmentStatus @default(UNFULFILLED)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  items             OrderItem[]
}

model OrderItem {
  id          String   @id @default(uuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id])
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  name        String
  quantity    Int
  price       Decimal  @db.Decimal(10, 2)
  variantInfo Json?
  createdAt   DateTime @default(now())
}

model StoreSettings {
  id             String   @id @default(uuid())
  storeId        String   @unique
  store          Store    @relation(fields: [storeId], references: [id])
  currency       String   @default("USD")
  timezone       String   @default("UTC")
  seoTitle       String?
  seoDescription String?
  socialImage    String?
  contactEmail   String?
  contactPhone   String?
  shippingMethods Json?
  paymentMethods  Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

enum Role {
  ADMIN
  MODERATOR
  MERCHANT
  CUSTOMER
}

enum AdminRole {
  SUPER_ADMIN
  SUPPORT_ADMIN
}

enum OnboardingStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
  BLOCKED
}

enum OnboardingStepStatus {
  PENDING
  COMPLETED
  SKIPPED
}

enum ActivityActorType {
  ADMIN
  MERCHANT
  SYSTEM
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketSource {
  CHATBOT
  EMAIL
  PORTAL
  ADMIN
}

enum AnalyticsPeriodType {
  DAILY
  WEEKLY
  MONTHLY
}

enum SupportChannel {
  PHONE
  VIDEO
  EMAIL
  CHAT
  OTHER
}

enum CommunicationChannel {
  EMAIL
  CHAT
  PHONE
  VIDEO
  OTHER
}

enum CommunicationDirection {
  INBOUND
  OUTBOUND
}

enum OrderStatus {
  PENDING
  CONFIRMED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum FulfillmentStatus {
  UNFULFILLED
  FULFILLED
  SHIPPED
  DELIVERED
}
